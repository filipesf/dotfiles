#!/usr/bin/env bash

set -euo pipefail

DOTFILES_DIR="$(cd "$(dirname "$0")" && pwd)"
BACKUP_DIR="$HOME/.dotfiles-backup/$(date +%Y%m%d-%H%M%S)"
SUBMODULES="non-vim"

for arg in "$@"; do
  case "$arg" in
    --submodules=all) SUBMODULES="all" ;;
    --submodules=non-vim) SUBMODULES="non-vim" ;;
    --submodules=none) SUBMODULES="none" ;;
  esac
done

backup_path() {
  local path="$1"

  if [ -e "$path" ] || [ -L "$path" ]; then
    mkdir -p "$BACKUP_DIR"
    mv "$path" "$BACKUP_DIR/"
  fi
}

link() {
  local src="$1"
  local dst="$2"

  backup_path "$dst"
  ln -sfn "$src" "$dst"
}

echo "Creating symlinks (backups in $BACKUP_DIR when needed)..."

echo "Bash..."
link "$DOTFILES_DIR/bashrc" "$HOME/.bashrc"
link "$DOTFILES_DIR/aliases" "$HOME/.aliases"
link "$DOTFILES_DIR/bash_profile" "$HOME/.bash_profile"

echo "Zsh..."
link "$DOTFILES_DIR/zshrc" "$HOME/.zshrc"
link "$DOTFILES_DIR/oh-my-zsh" "$HOME/.oh-my-zsh"

echo "Git..."
link "$DOTFILES_DIR/gitconfig" "$HOME/.gitconfig"
link "$DOTFILES_DIR/gitignore" "$HOME/.gitignore"
link "$DOTFILES_DIR/gitcommit" "$HOME/.gitcommit"

echo "Vim..."
link "$DOTFILES_DIR/vim" "$HOME/.vim"
link "$DOTFILES_DIR/vimrc" "$HOME/.vimrc"

echo "RubyGems..."
link "$DOTFILES_DIR/gemrc" "$HOME/.gemrc"

echo "EditorConfig..."
link "$DOTFILES_DIR/editorconfig" "$HOME/.editorconfig"

if [ "$SUBMODULES" != "none" ]; then
  echo "Submodules..."
  if [ "$SUBMODULES" = "all" ]; then
    git -C "$DOTFILES_DIR" submodule update --init --recursive
  else
    git -C "$DOTFILES_DIR" submodule update --init --recursive oh-my-zsh
  fi
fi
