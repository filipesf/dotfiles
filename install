#!/usr/bin/env bash

set -euo pipefail

DOTFILES_DIR="$(cd "$(dirname "$0")" && pwd)"
BACKUP_DIR="$HOME/.dotfiles-backup/$(date +%Y%m%d-%H%M%S)"
SUBMODULES="non-vim"

for arg in "$@"; do
  case "$arg" in
    --submodules=all) SUBMODULES="all" ;;
    --submodules=non-vim) SUBMODULES="non-vim" ;;
    --submodules=none) SUBMODULES="none" ;;
  esac
done

backup_path() {
  local path="$1"

  if [ -e "$path" ] || [ -L "$path" ]; then
    mkdir -p "$BACKUP_DIR"
    mv "$path" "$BACKUP_DIR/"
  fi
}

link() {
  local src="$1"
  local dst="$2"

  backup_path "$dst"
  ln -sfn "$src" "$dst"
}

echo "Creating symlinks (backups in $BACKUP_DIR when needed)..."

echo "Bash..."
link "$DOTFILES_DIR/bashrc" "$HOME/.bashrc"
link "$DOTFILES_DIR/aliases" "$HOME/.aliases"
link "$DOTFILES_DIR/bash_profile" "$HOME/.bash_profile"

echo "Zsh..."
link "$DOTFILES_DIR/zshrc" "$HOME/.zshrc"
link "$DOTFILES_DIR/oh-my-zsh" "$HOME/.oh-my-zsh"

echo "Git..."
link "$DOTFILES_DIR/gitconfig" "$HOME/.gitconfig"
link "$DOTFILES_DIR/gitignore" "$HOME/.gitignore"
link "$DOTFILES_DIR/gitcommit" "$HOME/.gitcommit"

echo "Vim..."
link "$DOTFILES_DIR/vim" "$HOME/.vim"
link "$DOTFILES_DIR/vimrc" "$HOME/.vimrc"

echo "RubyGems..."
link "$DOTFILES_DIR/gemrc" "$HOME/.gemrc"

echo "LLMs..."
LLM_AGENTS=("agents" "codex" "gemini" "claude")
LLM_DIRS=("agents" "get-shit-done" "hooks" "prompts" "skills")

for agent in "${LLM_AGENTS[@]}"; do
  agent_home="$HOME/.${agent}"
  backup_path "$agent_home"
  mkdir -p "$agent_home"

  for dir in "${LLM_DIRS[@]}"; do
    src="$DOTFILES_DIR/agents/$dir"
    if [ -e "$src" ] || [ -L "$src" ]; then
      link "$src" "$agent_home/$dir"
    fi
  done

  if [ "$agent" = "codex" ]; then
    link "$DOTFILES_DIR/agents/codex.config.sample.toml" "$agent_home/config.toml"
  elif [ "$agent" = "claude" ]; then
    link "$DOTFILES_DIR/agents/claude.settings.sample.json" "$agent_home/settings.json"
  elif [ "$agent" = "gemini" ]; then
    link "$DOTFILES_DIR/agents/gemini.settings.sample.json" "$agent_home/settings.json"
  fi

  if [ "$agent" = "claude" ]; then
    link "$DOTFILES_DIR/agents/SYSTEM.md" "$agent_home/CLAUDE.md"
  else
    link "$DOTFILES_DIR/agents/SYSTEM.md" "$agent_home/AGENTS.md"
  fi
done

echo "EditorConfig..."
link "$DOTFILES_DIR/editorconfig" "$HOME/.editorconfig"

if [ "$SUBMODULES" != "none" ]; then
  echo "Submodules..."
  if [ "$SUBMODULES" = "all" ]; then
    git -C "$DOTFILES_DIR" submodule update --init --recursive
  else
    git -C "$DOTFILES_DIR" submodule update --init --recursive oh-my-zsh
  fi
fi
