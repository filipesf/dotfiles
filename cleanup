#!/usr/bin/env bash

set -euo pipefail

DRY_RUN=false
NO_NODE=false
NO_DOCKER=false

for arg in "$@"; do
  case "$arg" in
    --dry-run) DRY_RUN=true ;;
    --no-node) NO_NODE=true ;;
    --no-docker) NO_DOCKER=true ;;
  esac
done

run() {
  if $DRY_RUN; then
    echo "DRY â†’ $*"
  else
    eval "$@"
  fi
}

size_of() {
  local path="$1"
  [[ -d "$path" ]] && du -sh "$path" 2>/dev/null | awk '{print $1}' || echo "0B"
}

cleanup() {
  local path="$1"
  echo "â†’ $path ($(size_of "$path"))"
  run "rm -rf \"$path\"/* 2>/dev/null || true"
}

echo ""
echo "ðŸ§¹ macOS Cleanup"
echo "================"
$DRY_RUN && echo "ðŸ§ª Dry-run enabled"
$NO_NODE && echo "ðŸš« Node cleanup disabled"
$NO_DOCKER && echo "ðŸš« Docker cleanup disabled"
echo ""

echo "ðŸ“Š Disk usage BEFORE:"
df -h /

echo ""
echo "ðŸ“‚ macOS caches & temp"
cleanup "$HOME/Library/Caches"
cleanup "/Library/Caches"
cleanup "/private/var/tmp"
cleanup "/private/var/folders"

echo ""
echo "ðŸ“œ Logs"
cleanup "$HOME/Library/Logs"
cleanup "$HOME/Library/Logs/DiagnosticReports"

echo ""
echo "âœ‰ï¸ Attachments"
cleanup "$HOME/Library/Containers/com.apple.mail/Data/Library/Mail Downloads"
cleanup "$HOME/Library/Messages/Attachments"

echo ""
echo "ðŸ§‘â€ðŸ’» Xcode"
cleanup "$HOME/Library/Developer/Xcode/DerivedData"
cleanup "$HOME/Library/Developer/Xcode/Archives"

echo ""
echo "ðŸ—‘ Trash"
cleanup "$HOME/.Trash"

# -----------------------
# Node / JS tooling
# -----------------------
if ! $NO_NODE; then
  echo ""
  echo "ðŸ“¦ Node / JS tooling"
  command -v npm >/dev/null && run "npm cache clean --force"
  command -v yarn >/dev/null && run "yarn cache clean"
  command -v pnpm >/dev/null && run "pnpm store prune"

  cleanup "$HOME/.npm"
  cleanup "$HOME/.yarn"
  cleanup "$HOME/.pnpm-store"
fi

# -----------------------
# Homebrew
# -----------------------
echo ""
echo "ðŸº Homebrew"
if command -v brew >/dev/null; then
  run "brew cleanup --prune=all"
  run "brew autoremove"
else
  echo "â†’ Not installed"
fi

# -----------------------
# Docker
# -----------------------
if ! $NO_DOCKER; then
  echo ""
  echo "ðŸ³ Docker"
  if command -v docker >/dev/null; then
    run "docker system prune -af"
    run "docker volume prune -f"
  else
    echo "â†’ Not installed"
  fi
fi

echo ""
echo "ðŸ“Š Disk usage AFTER:"
df -h /

echo ""
echo "âœ… Cleanup complete."
